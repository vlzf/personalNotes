# CDN 缓存策略

## 前言
举个例子：我要从家到超市买生活用品，但唯一的超市距离我我家有20公里，我学要花费很长时间。有一天，那家超市在我家旁边开了一家分店，从此，我去买东西就能节省很多时间。CDN 缓存就是用来实现这点的。

***

## CDN 缓存的作用
网络延迟有：
- 传播延迟：消息从发送端到接受端的所需时间。
- 传输延迟：把消息发送到链路所需时间。
- 处理延迟：处理分组首部、检查位错误、确定分组目标所需时间。
- 排队延迟：到达的分组等待处理的时间。

接受端和发送端距离越远，信息分组要经过的路由器就越多，四种网络延迟越严重，接受端接受信息所需时间就越长。所以，客户端与服务器距离越远，加载资源就越慢。

而 CDN 服务器就相当于源服务器的“分店”。它可以缓存源服务器的资源，可以为离它距离较近的用户提供资源，缩短资源传输距离，减少网络延迟。

> 《Web性能权威指南》：CDN （Content Delivery Network，内容分发网络）服务用途很多，但最重要的就是通过把内容部署在全球各地，让用户从最近的服务器加载内容，大幅降低传播分组的时间。或许我们不能让数据传输得更快，但我们可以缩短服务器与用户之间的距离！把数据托管到 CDN 能够显著提高性能。

***

## CDN 缓存过程
CDN 缓存过程也是遵循 http 缓存策略的。

客户端的资源请求过程：
- 检查：查看自身是否存在该资源的缓存，没有就向服务发请求。
- 强缓存判断：如果有缓存，通过 `expires` 或 `Cache-Control` 判断缓存是否过期。没过期就取缓存，过期就发请求（带协商缓存的相关控制首部）。
- 协商缓存判断：根据服务器返回信息从服务器加载资源（200）或从本地读取缓存（304）。


DNS 服务器对资源请求的处理（代理缓存）：
- 接收：缓存从网络中读取抵达的请求报文。
- 解析：缓存对请求报文进行解析；提取各种URL和各种首部；
- 查询：缓存查看是否有本地副本可用，如果没有，就向服务器获取一份副本，保存在本地；
- 新鲜度检测：缓存查看已缓存的副本是否新鲜，如果不新鲜，就询问源服务器是否有任何更新；
- 创建响应
- 发送
- 日志


源服务器对资源请求的处理：
- 接收：缓存从网络中读取抵达的请求报文。
- 解析：缓存对请求报文进行解析；提取各种URL和各种首部。
- 协商缓存判断：通过对比 `if-none-match` 和 `etag`，或对比 `if-modified-since` 和 `last-modified`，查看服务器本地资源是否更改，有更改返回 200，没更改返回 304。

***

END